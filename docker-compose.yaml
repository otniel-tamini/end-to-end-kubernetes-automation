version: '3.8'

services:
  consul:
    image: 'hashicorp/consul:1.15'
    container_name: consul
    command:
      - agent
      - '-dev'
      - '-client=0.0.0.0'
    ports:
      - '8500:8500'
    networks:
      - e-commerce-network

  # Instance MySQL unique pour tous les services
  mysql-db:
    image: 'mysql:8.0'
    container_name: mysql-db
    environment:
      MYSQL_ROOT_PASSWORD: '${MYSQL_ROOT_PASSWORD:-root}'
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      retries: 5
    networks:
      - e-commerce-network

  redis:
    image: 'redis:7.0-alpine'
    container_name: redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
    networks:
      - e-commerce-network

  config-server:
    image: 'otniel217/config-server:latest'
    container_name: config-server
    ports:
      - '1000:1000'
    environment:
      SPRING_CLOUD_CONFIG_SERVER_GIT_URI: 'https://github.com/otniel-tamini/end-to-end-kubernetes-automation.git'
      SPRING_CLOUD_CONFIG_SERVER_GIT_SEARCH_PATHS: configuration
      SPRING_CLOUD_CONFIG_SERVER_GIT_DEFAULT_LABEL: main
      SPRING_CLOUD_CONFIG_SERVER_GIT_USERNAME: '${GIT_USER}'
      SPRING_CLOUD_CONFIG_SERVER_GIT_PASSWORD: '${GIT_PASS}'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1000/actuator/health"]
      interval: 20s
      timeout: 5s
      retries: 5
    networks:
      - e-commerce-network

  user-service:
    image: otniel217/user-service:latest
    container_name: user-service
    depends_on:
      mysql-db: { condition: service_healthy }
      redis: { condition: service_healthy }
    networks:
      - e-commerce-network
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_CLOUD_CONFIG_ENABLED=false
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/user_db?createDatabaseIfNotExist=true
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD:-root}
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_CLOUD_CONSUL_HOST=consul
      - SPRING_APPLICATION_JSON={"app":{"baseUrl":"/api/v1/users","security":{"tokenValidity":{"accessValidity":3600000,"refreshValidity":604800000},"secretRotateIntervalMillis":86400000,"cookie":{"domain":"localhost","secure":false,"sameSite":"Lax"}}}}

  product-service:
    image: 'otniel217/product-service:latest'
    container_name: product-service
    depends_on:
      config-server: { condition: service_healthy }
      mysql-db: { condition: service_healthy }
      redis: { condition: service_healthy }
    networks:
      - e-commerce-network
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - CONSUL_HOST=consul
      - 'SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:1000'
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/product_db?createDatabaseIfNotExist=true
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD:-root}
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_APPLICATION_JSON={"app":{"base-url":"/api/v1"}}

  order-service:
    image: 'otniel217/order-service:latest'
    container_name: order-service
    depends_on:
      config-server: { condition: service_healthy }
      mysql-db: { condition: service_healthy }
      redis: { condition: service_healthy }
    networks:
      - e-commerce-network
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - CONSUL_HOST=consul
      - 'SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:1000'
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/order_db?createDatabaseIfNotExist=true
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD:-root}
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_APPLICATION_JSON={"app":{"base-url":"/api/v1"}}

  api-gateway:
    image: 'otniel217/api-gateway:latest'
    container_name: api-gateway
    ports:
      - '80:8080'
    depends_on:
      config-server: { condition: service_healthy }
    networks:
      - e-commerce-network
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - CONSUL_HOST=consul
      - 'SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:1000'

networks:
  e-commerce-network:
    driver: bridge